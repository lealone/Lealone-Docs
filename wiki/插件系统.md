# 插件系统

<cite>
**本文档中引用的文件**  
- [PluggableEngine.java](https://github.com/lealone/Lealone/blob/master/lealone-sci/src/main/java/com/lealone/db/plugin/PluggableEngine.java)
- [PluginManager.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/PluginManager.java)
- [Plugin.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/Plugin.java)
- [PluginBase.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/PluginBase.java)
- [PluginObject.java](https://github.com/lealone/Lealone/blob/master/lealone-db/src/main/java/com/lealone/db/plugin/PluginObject.java)
- [CreatePlugin.java](https://github.com/lealone/Lealone/blob/master/lealone-sql/src/main/java/com/lealone/sql/admin/CreatePlugin.java)
- [StartPlugin.java](https://github.com/lealone/Lealone/blob/master/lealone-sql/src/main/java/com/lealone/sql/admin/StartPlugin.java)
- [StorageEngine.java](https://github.com/lealone/Lealone/blob/master/lealone-sci/src/main/java/com/lealone/storage/StorageEngine.java)
- [AOStorageEngine.java](https://github.com/lealone/Lealone/blob/master/lealone-aose/src/main/java/com/lealone/storage/aose/AOStorageEngine.java)
- [PluginTest.java](https://github.com/lealone/Lealone/blob/master/lealone-test/src/test/java/com/lealone/test/sql/plugin/PluginTest.java)
</cite>

## 目录
1. [引言](#引言)
2. [插件系统架构](#插件系统架构)
3. [核心组件分析](#核心组件分析)
4. [插件生命周期管理](#插件生命周期管理)
5. [自定义插件开发指南](#自定义插件开发指南)
6. [插件配置与加载机制](#插件配置与加载机制)
7. [插件注册与发现机制](#插件注册与发现机制)
8. [完整插件开发示例](#完整插件开发示例)
9. [高级扩展场景](#高级扩展场景)
10. [故障排除指南](#故障排除指南)

## 引言
Lealone数据库系统采用高度模块化的插件架构，允许开发者通过插件机制扩展数据库的核心功能。本技术文档深入解析Lealone插件系统的实现原理，重点分析PluggableEngine.java和PluginManager.java的源码实现。文档详细说明如何开发自定义的存储引擎、事务引擎、SQL引擎或协议服务器插件，包括必须实现的接口和生命周期方法。通过本指南，高级开发者将能够全面掌握Lealone插件系统的扩展能力，为数据库功能的定制化开发提供详尽的技术指导。

## 插件系统架构

```mermaid
graph TD
subgraph "插件接口层"
Plugin[Plugin接口]
PluggableEngine[PluggableEngine接口]
StorageEngine[StorageEngine接口]
TransactionEngine[TransactionEngine接口]
SQLEngine[SQLEngine接口]
ProtocolServerEngine[ProtocolServerEngine接口]
end
subgraph "插件管理核心"
PluginManager[PluginManager]
PluginObject[PluginObject]
end
subgraph "插件实现层"
AOStorageEngine[AOStorageEngine]
LealoneSQLEngine[LealoneSQLEngine]
TcpServerEngine[TcpServerEngine]
AOTransactionEngine[AOTransactionEngine]
end
subgraph "插件生命周期"
CreatePlugin[CREATE PLUGIN]
StartPlugin[START PLUGIN]
StopPlugin[STOP PLUGIN]
DropPlugin[DROP PLUGIN]
end
Plugin --> PluginBase[PluginBase]
PluggableEngine --> Plugin
StorageEngine --> PluggableEngine
TransactionEngine --> PluggableEngine
SQLEngine --> PluggableEngine
ProtocolServerEngine --> PluggableEngine
PluginManager --> PluginObject
PluginObject --> Plugin
AOStorageEngine --> StorageEngine
LealoneSQLEngine --> SQLEngine
TcpServerEngine --> ProtocolServerEngine
AOTransactionEngine --> TransactionEngine
CreatePlugin --> PluginManager
StartPlugin --> PluginManager
StopPlugin --> PluginManager
DropPlugin --> PluginManager
PluginManager -.-> AOStorageEngine
PluginManager -.-> LealoneSQLEngine
PluginManager -.-> TcpServerEngine
PluginManager -.-> AOTransactionEngine
style Plugin fill:#f9f,stroke:#333
style PluggableEngine fill:#f9f,stroke:#333
style PluginManager fill:#bbf,stroke:#333
style PluginObject fill:#bbf,stroke:#333
```

**图示来源**
- [PluggableEngine.java](https://github.com/lealone/Lealone/blob/master/lealone-sci/src/main/java/com/lealone/db/plugin/PluggableEngine.java)
- [PluginManager.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/PluginManager.java)
- [StorageEngine.java](https://github.com/lealone/Lealone/blob/master/lealone-sci/src/main/java/com/lealone/storage/StorageEngine.java)

**本节来源**
- [PluggableEngine.java](https://github.com/lealone/Lealone/blob/master/lealone-sci/src/main/java/com/lealone/db/plugin/PluggableEngine.java)
- [PluginManager.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/PluginManager.java)

## 核心组件分析

### 插件接口体系
Lealone插件系统基于Java的接口和抽象类构建了一套完整的插件接口体系。核心接口包括Plugin接口和PluggableEngine接口，其中PluggableEngine接口扩展了Plugin接口，作为四大引擎（存储引擎、事务引擎、SQL引擎、协议服务器引擎）的标记接口。

```mermaid
classDiagram
class Plugin {
<<interface>>
+String getName()
+Map<String, String> getConfig()
+void init(Map<String, String> config)
+void close()
+void start()
+void stop()
+boolean isInited()
+boolean isStarted()
+boolean isStopped()
+State getState()
+enum State { NONE, INITED, STARTED, STOPPED }
}
class PluggableEngine {
<<interface>>
+<PE extends PluggableEngine> PE getEngine(Class<PE> engineClass, String engineName)
+<PE extends PluggableEngine> String getEngineType(Class<PE> engineClass)
}
class PluginBase {
<<abstract>>
-String name
-Map<String, String> config
-State state
+PluginBase()
+PluginBase(String name)
+String getName()
+void setName(String name)
+Map<String, String> getConfig()
+boolean isInited()
+boolean isStarted()
+boolean isStopped()
+synchronized void init(Map<String, String> config)
+synchronized void close()
+void start()
+void stop()
+State getState()
+Class<? extends Plugin> getPluginClass()
}
Plugin <|-- PluggableEngine
Plugin <|-- PluginBase
PluggableEngine <|-- StorageEngine
PluggableEngine <|-- TransactionEngine
PluggableEngine <|-- SQLEngine
PluggableEngine <|-- ProtocolServerEngine
class StorageEngine {
<<interface>>
+StorageBuilder getStorageBuilder()
+LobStorage getLobStorage(DataHandler dataHandler, Storage storage)
+static StorageEngine getDefaultStorageEngine()
}
class TransactionEngine {
<<interface>>
+Transaction newTransaction()
+TransactionMap newTransactionMap(String mapName, String keyDataTypeName, String valueDataTypeName)
}
class SQLEngine {
<<interface>>
+SQLParser createSQLParser()
+PreparedSQLStatement prepareSQLStatement(String sql)
}
class ProtocolServerEngine {
<<interface>>
+ProtocolServer createProtocolServer()
+String[] getSupportedProtocolTypes()
}
```

**图示来源**
- [Plugin.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/Plugin.java)
- [PluggableEngine.java](https://github.com/lealone/Lealone/blob/master/lealone-sci/src/main/java/com/lealone/db/plugin/PluggableEngine.java)
- [PluginBase.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/PluginBase.java)
- [StorageEngine.java](https://github.com/lealone/Lealone/blob/master/lealone-sci/src/main/java/com/lealone/storage/StorageEngine.java)

**本节来源**
- [Plugin.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/Plugin.java)
- [PluggableEngine.java](https://github.com/lealone/Lealone/blob/master/lealone-sci/src/main/java/com/lealone/db/plugin/PluggableEngine.java)
- [PluginBase.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/PluginBase.java)

### 插件管理器实现
PluginManager类是Lealone插件系统的核心管理组件，负责插件的注册、发现和生命周期管理。它采用单例模式和线程安全的设计，确保在多线程环境下插件管理的正确性。

```mermaid
classDiagram
class PluginManager~T~ {
-static final Logger logger
-final Class<T> pluginClass
-final Map<String, T> plugins
-volatile boolean loaded
-PluginManager(Class<T> pluginClass)
+T getPlugin(String name)
+Collection<T> getPlugins()
+void registerPlugin(T plugin, String... alias)
+void deregisterPlugin(T plugin, String... alias)
-synchronized void loadPlugins()
-static final Map<Class<?>, PluginManager<?>> instances
+static <P extends Plugin> P getPlugin(Class<P> pluginClass, String name)
+static <P extends Plugin> Collection<P> getPlugins(Class<P> pluginClass)
+static <P extends Plugin> void register(P plugin, String... alias)
+static <P extends Plugin> void register(Class<P> pluginClass, P plugin, String... alias)
+static <P extends Plugin> void deregister(P plugin, String... alias)
+static <P extends Plugin> void deregister(Class<P> pluginClass, P plugin, String... alias)
}
class PluginObject {
-final String implementBy
-final String classPath
-final CaseInsensitiveMap<String> parameters
-Plugin plugin
-URLClassLoader classLoader
-String state
+PluginObject(Database database, int id, String pluginName, String implementBy, String classPath, CaseInsensitiveMap<String> parameters)
+DbObjectType getType()
+Plugin getPlugin()
+void setPlugin(Plugin plugin)
+URLClassLoader getClassLoader()
+void setClassLoader(URLClassLoader classLoader)
+void close()
+String getCreateSQL()
+void start()
+void stop()
+String getState()
+boolean isAutoStart()
}
PluginManager <|-- PluginManager~T~
PluginObject --> Plugin
PluginManager~T~ --> PluginObject
```

**图示来源**
- [PluginManager.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/PluginManager.java)
- [PluginObject.java](https://github.com/lealone/Lealone/blob/master/lealone-db/src/main/java/com/lealone/db/plugin/PluginObject.java)

**本节来源**
- [PluginManager.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/PluginManager.java)
- [PluginObject.java](https://github.com/lealone/Lealone/blob/master/lealone-db/src/main/java/com/lealone/db/plugin/PluginObject.java)

## 插件生命周期管理

### 插件生命周期状态机
Lealone插件系统定义了清晰的生命周期状态机，确保插件在不同状态间的正确转换。插件状态包括NONE、INITED、STARTED和STOPPED四种，通过状态机严格控制插件的初始化、启动、停止和关闭过程。

```mermaid
stateDiagram-v2
[*] --> NONE
NONE --> INITED : init()
INITED --> STARTED : start()
STARTED --> STOPPED : stop()
STOPPED --> INITED : start()
INITED --> NONE : close()
STARTED --> NONE : close()
STOPPED --> NONE : close()
state "未初始化" as NONE
state "已初始化" as INITED
state "已启动" as STARTED
state "已停止" as STOPPED
NONE : 插件未初始化状态
INITED : 插件已初始化但未启动
STARTED : 插件已启动并运行
STOPPED : 插件已停止但未关闭
note right of NONE
插件实例创建后的初始状态
此时插件尚未配置和初始化
end note
note right of INITED
CREATE PLUGIN命令执行后进入此状态
插件已配置但未启动运行
end note
note right of STARTED
START PLUGIN命令执行后进入此状态
插件正在运行并提供服务
end note
note right of STOPPED
STOP PLUGIN命令执行后进入此状态
插件已停止服务但未释放资源
end note
```

**图示来源**
- [Plugin.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/Plugin.java)
- [PluginBase.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/PluginBase.java)

**本节来源**
- [Plugin.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/Plugin.java)
- [PluginBase.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/PluginBase.java)

### 插件生命周期操作流程
Lealone通过SQL命令实现插件的全生命周期管理，包括创建、启动、停止和删除操作。这些操作通过相应的SQL语句触发，由数据库内核调用插件管理器完成具体操作。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant SQLParser as "SQL解析器"
participant CreatePlugin as "CreatePlugin"
participant PluginManager as "PluginManager"
participant PluginObject as "PluginObject"
participant Plugin as "插件实例"
Client->>SQLParser : CREATE PLUGIN ... IMPLEMENT BY ...
SQLParser->>CreatePlugin : 解析并创建CreatePlugin实例
CreatePlugin->>PluginManager : 检查插件是否存在
alt 插件不存在
CreatePlugin->>CreatePlugin : 使用反射创建插件实例
CreatePlugin->>Plugin : 调用init(config)方法
CreatePlugin->>PluginObject : 创建PluginObject实例
PluginObject->>PluginObject : 设置插件实例和类加载器
CreatePlugin->>LealoneDatabase : 添加PluginObject到数据库对象
CreatePlugin->>PluginObject : 如果auto_start则调用start()
CreatePlugin-->>Client : 返回成功
else 插件已存在且if not exists
CreatePlugin-->>Client : 返回成功无操作
else 插件已存在
CreatePlugin-->>Client : 抛出插件已存在异常
end
```

```mermaid
sequenceDiagram
participant Client as "客户端"
participant SQLParser as "SQL解析器"
participant StartPlugin as "StartPlugin"
participant PluginObject as "PluginObject"
participant Plugin as "插件实例"
Client->>SQLParser : START PLUGIN plugin_name
SQLParser->>StartPlugin : 解析并创建StartPlugin实例
StartPlugin->>LealoneDatabase : 查找PluginObject
alt 插件存在
StartPlugin->>PluginObject : 调用start()方法
PluginObject->>Plugin : 调用插件的start()方法
PluginObject->>PluginObject : 更新状态为"started"
StartPlugin-->>Client : 返回成功
else 插件不存在
StartPlugin-->>Client : 抛出插件不存在异常
end
```

**图示来源**
- [CreatePlugin.java](https://github.com/lealone/Lealone/blob/master/lealone-sql/src/main/java/com/lealone/sql/admin/CreatePlugin.java)
- [StartPlugin.java](https://github.com/lealone/Lealone/blob/master/lealone-sql/src/main/java/com/lealone/sql/admin/StartPlugin.java)
- [PluginObject.java](https://github.com/lealone/Lealone/blob/master/lealone-db/src/main/java/com/lealone/db/plugin/PluginObject.java)

**本节来源**
- [CreatePlugin.java](https://github.com/lealone/Lealone/blob/master/lealone-sql/src/main/java/com/lealone/sql/admin/CreatePlugin.java)
- [StartPlugin.java](https://github.com/lealone/Lealone/blob/master/lealone-sql/src/main/java/com/lealone/sql/admin/StartPlugin.java)
- [PluginObject.java](https://github.com/lealone/Lealone/blob/master/lealone-db/src/main/java/com/lealone/db/plugin/PluginObject.java)

## 自定义插件开发指南

### 存储引擎插件开发
开发自定义存储引擎需要实现StorageEngine接口，该接口定义了存储引擎的核心功能，包括存储构建器和LOB存储的创建。

```mermaid
classDiagram
class StorageEngine {
<<interface>>
+StorageBuilder getStorageBuilder()
+LobStorage getLobStorage(DataHandler dataHandler, Storage storage)
+static StorageEngine getDefaultStorageEngine()
}
class StorageBuilder {
<<interface>>
+StorageBuilder setConfig(Map<String, String> config)
+StorageBuilder setStorageName(String storageName)
+StorageBuilder setDataHandler(DataHandler dataHandler)
+Storage build()
}
class Storage {
<<interface>>
+String getName()
+StorageMap newMap(String mapName, String keyDataTypeName, String valueDataTypeName)
+void close()
+boolean isClosed()
}
class StorageMap {
<<interface>>
+String getName()
+void put(Object key, Object value)
+Object get(Object key)
+void remove(Object key)
+StorageMapCursor cursor(CursorParameters parameters)
+void close()
+boolean isClosed()
}
class StorageMapCursor {
<<interface>>
+boolean hasNext()
+Map.Entry next()
+void close()
}
StorageEngine <|-- CustomStorageEngine
CustomStorageEngine --> StorageBuilderImpl
StorageBuilderImpl --> StorageImpl
StorageImpl --> StorageMapImpl
StorageMapImpl --> StorageMapCursorImpl
```

**本节来源**
- [StorageEngine.java](https://github.com/lealone/Lealone/blob/master/lealone-sci/src/main/java/com/lealone/storage/StorageEngine.java)
- [AOStorageEngine.java](https://github.com/lealone/Lealone/blob/master/lealone-aose/src/main/java/com/lealone/storage/aose/AOStorageEngine.java)

### 事务引擎插件开发
事务引擎插件需要实现TransactionEngine接口，提供事务管理和事务映射的创建功能。

```mermaid
classDiagram
class TransactionEngine {
<<interface>>
+Transaction newTransaction()
+TransactionMap newTransactionMap(String mapName, String keyDataTypeName, String valueDataTypeName)
}
class Transaction {
<<interface>>
+void begin()
+void commit()
+void rollback()
+boolean isActive()
+int getTransactionId()
}
class TransactionMap {
<<interface>>
+String getName()
+void put(Object key, Object value)
+Object get(Object key)
+void remove(Object key)
+TransactionMapCursor cursor(CursorParameters parameters)
+void close()
+boolean isClosed()
}
class TransactionMapCursor {
<<interface>>
+boolean hasNext()
+Map.Entry next()
+void close()
}
TransactionEngine <|-- CustomTransactionEngine
CustomTransactionEngine --> TransactionImpl
CustomTransactionEngine --> TransactionMapImpl
TransactionMapImpl --> TransactionMapCursorImpl
```

**本节来源**
- [TransactionEngine.java](https://github.com/lealone/Lealone/blob/master/lealone-sci/src/main/java/com/lealone/transaction/TransactionEngine.java)

### SQL引擎插件开发
SQL引擎插件需要实现SQLEngine接口，提供SQL解析和预编译语句的创建功能。

```mermaid
classDiagram
class SQLEngine {
<<interface>>
+SQLParser createSQLParser()
+PreparedSQLStatement prepareSQLStatement(String sql)
}
class SQLParser {
<<interface>>
+ParsedSQLStatement parse(String sql)
+void setSession(ServerSession session)
}
class ParsedSQLStatement {
<<interface>>
+int getType()
+PreparedSQLStatement prepare()
}
class PreparedSQLStatement {
<<interface>>
+int update()
+Result query(int maxRows)
+void close()
}
SQLEngine <|-- CustomSQLEngine
CustomSQLEngine --> SQLParserImpl
SQLParserImpl --> ParsedSQLStatementImpl
ParsedSQLStatementImpl --> PreparedSQLStatementImpl
```

**本节来源**
- [SQLEngine.java](https://github.com/lealone/Lealone/blob/master/lealone-sci/src/main/java/com/lealone/sql/SQLEngine.java)

### 协议服务器插件开发
协议服务器插件需要实现ProtocolServerEngine接口，提供协议服务器的创建和支持的协议类型。

```mermaid
classDiagram
class ProtocolServerEngine {
<<interface>>
+ProtocolServer createProtocolServer()
+String[] getSupportedProtocolTypes()
}
class ProtocolServer {
<<interface>>
+void start()
+void stop()
+boolean isRunning()
+String getProtocolType()
+int getPort()
}
ProtocolServerEngine <|-- CustomProtocolServerEngine
CustomProtocolServerEngine --> ProtocolServerImpl
```

**本节来源**
- [ProtocolServerEngine.java](https://github.com/lealone/Lealone/blob/master/lealone-sci/src/main/java/com/lealone/server/ProtocolServerEngine.java)

## 插件配置与加载机制

### 插件配置机制
Lealone插件系统支持灵活的配置机制，允许通过CREATE PLUGIN语句的PARAMETERS子句传递配置参数。

```mermaid
flowchart TD
Start([CREATE PLUGIN语句]) --> ParseParameters["解析PARAMETERS子句"]
ParseParameters --> CreateMap["创建CaseInsensitiveMap<String>"]
CreateMap --> AddConfig["添加内置配置参数"]
AddConfig --> plugin_name["plugin_name: 插件名称"]
AddConfig --> auto_start["auto_start: 是否自动启动"]
AddConfig --> user_defined["用户自定义参数"]
AddConfig --> CallInit["调用插件的init(config)方法"]
CallInit --> Plugin["插件实现"]
Plugin --> ProcessConfig["处理配置参数"]
ProcessConfig --> ValidateConfig["验证配置有效性"]
ValidateConfig --> ApplyConfig["应用配置到插件"]
ApplyConfig --> End([插件初始化完成])
style Start fill:#f9f,stroke:#333
style End fill:#f9f,stroke:#333
style Plugin fill:#bbf,stroke:#333
```

**本节来源**
- [CreatePlugin.java](https://github.com/lealone/Lealone/blob/master/lealone-sql/src/main/java/com/lealone/sql/admin/CreatePlugin.java)
- [PluginBase.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/PluginBase.java)

### 插件加载机制
Lealone使用Java的ServiceLoader机制实现插件的自动发现和加载，同时支持通过CLASS PATH子句指定外部JAR包中的插件。

```mermaid
flowchart TD
Start([PluginManager.getPlugin]) --> CheckLoaded["检查是否已加载"]
CheckLoaded --> |否| LoadPlugins["调用loadPlugins()"]
LoadPlugins --> ServiceLoader["创建ServiceLoader实例"]
ServiceLoader --> Iterate["迭代ServiceLoader"]
Iterate --> HasNext["是否有下一个插件?"]
HasNext --> |是| NextPlugin["获取下一个插件实例"]
NextPlugin --> Register["注册插件到plugins映射"]
Register --> Continue["继续迭代"]
Continue --> HasNext
HasNext --> |否| SetLoaded["设置loaded = true"]
SetLoaded --> End1([插件加载完成])
CheckLoaded --> |是| GetPlugin["从plugins映射获取插件"]
GetPlugin --> End2([返回插件实例])
style Start fill:#f9f,stroke:#333
style End1 fill:#f9f,stroke:#333
style End2 fill:#f9f,stroke:#333
style LoadPlugins fill:#bbf,stroke:#333
```

**本节来源**
- [PluginManager.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/PluginManager.java)

## 插件注册与发现机制

### 插件注册机制
Lealone插件系统采用基于类的注册机制，支持通过插件类和插件名称的双重键值进行注册和查找。

```mermaid
classDiagram
class PluginRegistry {
-Map<Class<?>, PluginManager<?>> instances
+<P extends Plugin> PluginManager<P> getInstance(Class<P> pluginClass)
+<P extends Plugin> PluginManager<P> getInstance(P plugin)
}
class PluginManager~T~ {
-Class<T> pluginClass
-Map<String, T> plugins
+void registerPlugin(T plugin, String... alias)
+void deregisterPlugin(T plugin, String... alias)
+T getPlugin(String name)
}
PluginRegistry --> PluginManager~T~
PluginManager~T~ --> PluginRegistry
note right of PluginRegistry
单例注册中心，管理所有PluginManager实例
使用ConcurrentHashMap确保线程安全
end note
note right of PluginManager~T~
特定类型插件的管理器
使用ConcurrentHashMap存储插件实例
插件名称不区分大小写
end note
```

**本节来源**
- [PluginManager.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/PluginManager.java)

### 插件发现机制
插件发现机制结合了ServiceLoader自动发现和动态注册两种方式，提供了灵活的插件管理能力。

```mermaid
sequenceDiagram
participant Application as "应用程序"
participant PluginManager as "PluginManager"
participant ServiceLoader as "ServiceLoader"
participant PluginRegistry as "插件注册表"
Application->>PluginManager : getPlugin(StorageEngine.class, "AOSE")
PluginManager->>PluginRegistry : getInstance(StorageEngine.class)
PluginRegistry->>PluginRegistry : 检查instances缓存
alt 缓存中不存在
PluginRegistry->>PluginRegistry : 创建新的PluginManager实例
PluginRegistry->>PluginRegistry : 放入instances缓存
end
PluginRegistry-->>PluginManager : 返回PluginManager实例
PluginManager->>PluginManager : 检查loaded标志
alt 未加载
PluginManager->>ServiceLoader : load(StorageEngine.class)
ServiceLoader->>ServiceLoader : 查找META-INF/services/com.lealone.storage.StorageEngine
ServiceLoader->>PluginManager : 返回插件实现类列表
loop 每个插件实现类
ServiceLoader->>PluginManager : 创建插件实例
PluginManager->>PluginManager : 调用registerPlugin()
end
PluginManager->>PluginManager : 设置loaded = true
end
PluginManager->>PluginManager : 从plugins映射获取插件
PluginManager-->>Application : 返回插件实例
```

**本节来源**
- [PluginManager.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/PluginManager.java)

## 完整插件开发示例

### 自定义存储引擎插件
以下是一个完整的自定义存储引擎插件开发示例，展示了从接口实现到注册的全过程。

```mermaid
flowchart TD
Start([创建Maven项目]) --> AddDependency["添加Lealone依赖"]
AddDependency --> ImplementInterface["实现StorageEngine接口"]
ImplementInterface --> CreateBuilder["创建StorageBuilder实现"]
CreateBuilder --> CreateStorage["创建Storage实现"]
CreateStorage --> CreateMap["创建StorageMap实现"]
CreateMap --> CreateCursor["创建StorageMapCursor实现"]
CreateCursor --> ImplementMethods["实现核心方法"]
ImplementMethods --> CreateServiceFile["创建META-INF/services文件"]
CreateServiceFile --> BuildJar["构建JAR包"]
BuildJar --> Deploy["部署到Lealone"]
Deploy --> Test["测试插件功能"]
Test --> End([完成])
style Start fill:#f9f,stroke:#333
style End fill:#f9f,stroke:#333
style ImplementInterface fill:#bbf,stroke:#333
style CreateServiceFile fill:#bbf,stroke:#333
```

**本节来源**
- [AOStorageEngine.java](https://github.com/lealone/Lealone/blob/master/lealone-aose/src/main/java/com/lealone/storage/aose/AOStorageEngine.java)
- [PluginTest.java](https://github.com/lealone/Lealone/blob/master/lealone-test/src/test/java/com/lealone/test/sql/plugin/PluginTest.java)

### 插件部署与测试
插件部署和测试流程包括创建、启动、使用和清理等步骤。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Lealone as "Lealone数据库"
participant PluginManager as "PluginManager"
participant CustomPlugin as "自定义插件"
Client->>Lealone : CREATE PLUGIN MyStorageEngine IMPLEMENT BY 'com.example.MyStorageEngine'
Lealone->>PluginManager : 创建MyStorageEngine实例
PluginManager->>CustomPlugin : 调用init(config)
CustomPlugin-->>PluginManager : 初始化完成
PluginManager-->>Lealone : 注册插件
Lealone-->>Client : 返回成功
Client->>Lealone : START PLUGIN MyStorageEngine
Lealone->>CustomPlugin : 调用start()
CustomPlugin-->>Lealone : 启动完成
Lealone-->>Client : 返回成功
Client->>Lealone : 使用MyStorageEngine创建表
Lealone->>CustomPlugin : 调用getStorageBuilder()
CustomPlugin-->>Lealone : 返回StorageBuilder
Lealone->>CustomPlugin : 构建Storage实例
CustomPlugin-->>Lealone : 返回Storage实例
Lealone-->>Client : 表创建成功
Client->>Lealone : STOP PLUGIN MyStorageEngine
Lealone->>CustomPlugin : 调用stop()
CustomPlugin-->>Lealone : 停止完成
Lealone-->>Client : 返回成功
Client->>Lealone : DROP PLUGIN MyStorageEngine
Lealone->>CustomPlugin : 调用close()
CustomPlugin-->>Lealone : 关闭完成
Lealone->>PluginManager : 从注册表移除
PluginManager-->>Lealone : 移除完成
Lealone-->>Client : 返回成功
```

**本节来源**
- [PluginTest.java](https://github.com/lealone/Lealone/blob/master/lealone-test/src/test/java/com/lealone/test/sql/plugin/PluginTest.java)

## 高级扩展场景

### 多引擎协同工作
Lealone插件系统支持多个引擎协同工作，实现复杂的功能扩展。

```mermaid
graph TD
subgraph "核心引擎"
SQL[SQLEngine]
Transaction[TransactionEngine]
Storage[StorageEngine]
Protocol[ProtocolServerEngine]
end
subgraph "扩展功能"
Cache[缓存引擎]
Search[搜索引擎]
Analytics[分析引擎]
Security[安全引擎]
end
SQL --> Transaction
Transaction --> Storage
Protocol --> SQL
Cache --> Storage
Search --> Storage
Analytics --> Storage
Security --> SQL
Security --> Transaction
Security --> Storage
Security --> Protocol
style SQL fill:#f96,stroke:#333
style Transaction fill:#f96,stroke:#333
style Storage fill:#f96,stroke:#333
style Protocol fill:#f96,stroke:#333
style Cache fill:#6f9,stroke:#333
style Search fill:#6f9,stroke:#333
style Analytics fill:#6f9,stroke:#333
style Security fill:#6f9,stroke:#333
note right of SQL
负责SQL语句的解析和执行
与事务引擎协同管理事务
end note
note right of Transaction
负责事务的创建和管理
确保数据的一致性和隔离性
end note
note right of Storage
负责数据的持久化存储
提供高效的数据访问接口
end note
note right of Protocol
负责网络协议的处理
支持多种客户端连接方式
end note
note right of Cache
提供数据缓存功能
加速热点数据的访问
end note
note right of Search
提供全文搜索功能
支持复杂的查询需求
end note
note right of Analytics
提供数据分析功能
支持实时统计和报表
end note
note right of Security
提供安全控制功能
包括认证、授权和加密
end note
```

**本节来源**
- [PluggableEngine.java](https://github.com/lealone/Lealone/blob/master/lealone-sci/src/main/java/com/lealone/db/plugin/PluggableEngine.java)
- [PluginManager.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/PluginManager.java)

### 插件热部署
Lealone支持插件的热部署，允许在不重启数据库的情况下动态加载和卸载插件。

```mermaid
sequenceDiagram
participant Admin as "管理员"
participant Lealone as "Lealone数据库"
participant PluginManager as "PluginManager"
participant NewPlugin as "新插件"
Admin->>Lealone : CREATE PLUGIN NewFeature IMPLEMENT BY 'com.example.NewFeature'
Lealone->>PluginManager : 动态加载新插件
PluginManager->>NewPlugin : 调用init(config)
NewPlugin-->>PluginManager : 初始化完成
PluginManager-->>Lealone : 注册新插件
Lealone-->>Admin : 返回成功
Admin->>Lealone : START PLUGIN NewFeature
Lealone->>NewPlugin : 调用start()
NewPlugin-->>Lealone : 启动完成
Lealone-->>Admin : 返回成功
Admin->>Lealone : 使用NewFeature功能
Lealone->>NewPlugin : 调用相应方法
NewPlugin-->>Lealone : 返回结果
Lealone-->>Admin : 返回结果
Admin->>Lealone : STOP PLUGIN NewFeature
Lealone->>NewPlugin : 调用stop()
NewPlugin-->>Lealone : 停止完成
Lealone-->>Admin : 返回成功
Admin->>Lealone : DROP PLUGIN NewFeature
Lealone->>NewPlugin : 调用close()
NewPlugin-->>Lealone : 关闭完成
Lealone->>PluginManager : 从注册表移除
PluginManager-->>Lealone : 移除完成
Lealone-->>Admin : 返回成功
```

**本节来源**
- [PluginManager.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/PluginManager.java)
- [PluginObject.java](https://github.com/lealone/Lealone/blob/master/lealone-db/src/main/java/com/lealone/db/plugin/PluginObject.java)

## 故障排除指南

### 常见问题及解决方案
本节列出插件开发和使用过程中可能遇到的常见问题及其解决方案。

```mermaid
flowchart TD
Problem1["插件类找不到"] --> Solution1["检查CLASS PATH配置是否正确"]
Problem2["插件初始化失败"] --> Solution2["检查init方法中的异常"]
Problem3["插件启动失败"] --> Solution3["检查start方法中的异常"]
Problem4["插件无法注册"] --> Solution4["检查插件名称是否冲突"]
Problem5["插件方法调用失败"] --> Solution5["检查插件是否已启动"]
Problem6["插件资源泄漏"] --> Solution6["确保close方法正确释放资源"]
Problem7["插件性能问题"] --> Solution7["检查插件实现的性能瓶颈"]
Problem8["插件兼容性问题"] --> Solution8["检查Lealone版本兼容性"]
style Problem1 fill:#f66,stroke:#333,color:#fff
style Problem2 fill:#f66,stroke:#333,color:#fff
style Problem3 fill:#f66,stroke:#333,color:#fff
style Problem4 fill:#f66,stroke:#333,color:#fff
style Problem5 fill:#f66,stroke:#333,color:#fff
style Problem6 fill:#f66,stroke:#333,color:#fff
style Problem7 fill:#f66,stroke:#333,color:#fff
style Problem8 fill:#f66,stroke:#333,color:#fff
style Solution1 fill:#6f6,stroke:#333,color:#fff
style Solution2 fill:#6f6,stroke:#333,color:#fff
style Solution3 fill:#6f6,stroke:#333,color:#fff
style Solution4 fill:#6f6,stroke:#333,color:#fff
style Solution5 fill:#6f6,stroke:#333,color:#fff
style Solution6 fill:#6f6,stroke:#333,color:#fff
style Solution7 fill:#6f6,stroke:#333,color:#fff
style Solution8 fill:#6f6,stroke:#333,color:#fff
```

**本节来源**
- [PluginManager.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/PluginManager.java)
- [PluginBase.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/PluginBase.java)

### 调试技巧
提供插件调试的有效技巧和方法。

```mermaid
flowchart TD
Start([调试插件]) --> EnableLogging["启用详细日志"]
EnableLogging --> SetLogLevel["设置日志级别为DEBUG"]
SetLogLevel --> AddLog["在关键方法添加日志"]
AddLog --> init["init方法日志"]
AddLog --> start["start方法日志"]
AddLog --> stop["stop方法日志]
AddLog --> close["close方法日志]
AddLog --> UseDebugger["使用调试器"]
UseDebugger --> SetBreakpoint["在关键位置设置断点"]
SetBreakpoint --> StepThrough["逐步执行代码"]
StepThrough --> InspectVars["检查变量状态"]
AddLog --> MonitorPerformance["监控性能"]
MonitorPerformance --> MeasureTime["测量方法执行时间"]
MeasureTime --> IdentifyBottleneck["识别性能瓶颈"]
IdentifyBottleneck --> Optimize["优化代码"]
AddLog --> TestLifecycle["测试生命周期"]
TestLifecycle --> CreatePlugin["CREATE PLUGIN"]
TestLifecycle --> StartPlugin["START PLUGIN"]
TestLifecycle --> UsePlugin["使用插件"]
TestLifecycle --> StopPlugin["STOP PLUGIN"]
TestLifecycle --> DropPlugin["DROP PLUGIN"]
style Start fill:#f9f,stroke:#333
style EnableLogging fill:#bbf,stroke:#333
style UseDebugger fill:#bbf,stroke:#333
style MonitorPerformance fill:#bbf,stroke:#333
style TestLifecycle fill:#bbf,stroke:#333
```

**本节来源**
- [PluginBase.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/PluginBase.java)
- [PluginManager.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/db/plugin/PluginManager.java)