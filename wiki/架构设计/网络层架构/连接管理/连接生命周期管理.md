# 连接生命周期管理


**本文档引用的文件**  
- [AsyncConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnection.java)
- [AsyncConnectionManager.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnectionManager.java)
- [AsyncConnectionPool.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnectionPool.java)
- [AsyncServer.java](https://github.com/lealone/Lealone/blob/master/lealone-server/src/main/java/com/lealone/server/AsyncServer.java)
- [AsyncServerManager.java](https://github.com/lealone/Lealone/blob/master/lealone-server/src/main/java/com/lealone/server/AsyncServerManager.java)
- [TcpClientConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/TcpClientConnection.java)
- [TcpServerConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-server/src/main/java/com/lealone/server/TcpServerConnection.java)
- [TransferConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/TransferConnection.java)
- [NetClientBase.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/NetClientBase.java)
- [NetServerBase.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/NetServerBase.java)
- [NetBuffer.java](https://github.com/lealone/Lealone/blob/master/lealone-common/src/main/java/com/lealone/net/NetBuffer.java)
- [ClientSessionFactory.java](https://github.com/lealone/Lealone/blob/master/lealone-client/src/main/java/com/lealone/client/session/ClientSessionFactory.java)
- [Database.java](https://github.com/lealone/Lealone/blob/master/lealone-db/src/main/java/com/lealone/db/Database.java)


## 目录
1. [连接生命周期概述](#连接生命周期概述)
2. [核心组件分析](#核心组件分析)
3. [连接创建流程](#连接创建流程)
4. [身份验证与会话建立](#身份验证与会话建立)
5. [连接状态管理](#连接状态管理)
6. [连接关闭与资源释放](#连接关闭与资源释放)
7. [AsyncConnectionManager与AsyncServerManager协作](#asyncconnectionmanager与asyncservermanager协作)
8. [关键方法实现细节](#关键方法实现细节)
9. [连接泄漏检测与性能监控](#连接泄漏检测与性能监控)
10. [最佳实践](#最佳实践)

## 连接生命周期概述

Lealone数据库系统的连接生命周期管理机制涵盖了从客户端连接请求到达、连接对象创建、身份验证、会话建立到连接关闭和资源释放的完整过程。该机制通过AsyncConnectionManager和AsyncServerManager两个核心组件的协作，实现了高效的连接状态管理、异常处理和资源清理。

连接生命周期始于客户端发起连接请求，经过网络层接收后创建AsyncConnection对象。随后进行身份验证和会话初始化，建立客户端与服务器之间的通信会话。在连接活跃期间，系统通过连接池和事件循环机制管理连接状态，处理各种数据库操作请求。当连接不再需要时，系统会执行优雅的关闭流程，确保所有相关资源被正确释放。

整个生命周期中，连接状态在不同阶段之间转换，包括初始化、认证中、活跃、空闲和关闭等状态。系统通过超时检测、异常处理和资源监控等机制确保连接管理的健壮性和可靠性。

**连接生命周期状态转换图**

```mermaid
stateDiagram-v2
[*] --> 初始化
初始化 --> 认证中 : 接收连接请求
认证中 --> 活跃 : 身份验证成功
认证中 --> 关闭 : 身份验证失败
活跃 --> 空闲 : 无活动
空闲 --> 活跃 : 接收新请求
活跃 --> 关闭 : 显式关闭或超时
空闲 --> 关闭 : 超时
关闭 --> [*]
```

**图示来源**
- [AsyncConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnection.java)
- [TcpServerConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-server/src/main/java/com/lealone/server/TcpServerConnection.java)

## 核心组件分析

Lealone连接生命周期管理涉及多个核心组件，它们协同工作以实现完整的连接管理功能。

**AsyncConnection** 是所有异步连接的抽象基类，定义了连接的基本行为和状态管理。它封装了可写通道(WritableChannel)，提供了连接处理、关闭和异常处理的基本方法。

**AsyncConnectionManager** 是连接管理的接口，定义了创建和移除连接的方法。它作为连接管理的抽象层，允许不同类型的服务器实现自己的连接管理策略。

**AsyncServerManager** 是服务器管理的静态类，负责管理所有异步服务器实例。它维护服务器ID分配、注册接受者任务和服务器生命周期管理。

**TcpClientConnection** 和 **TcpServerConnection** 分别代表客户端和服务器端的TCP连接实现。它们继承自TransferConnection，实现了具体的连接处理逻辑。

**NetClientBase** 和 **NetServerBase** 提供了网络客户端和服务器的基础实现，包括连接池管理、连接创建和销毁等通用功能。

```mermaid
classDiagram
class AsyncConnection {
+WritableChannel writableChannel
+boolean isServer
+InetSocketAddress inetSocketAddress
+boolean closed
+close()
+isClosed()
+handleException(Exception e)
}
class AsyncConnectionManager {
+createConnection(WritableChannel, boolean, Scheduler)
+removeConnection(AsyncConnection)
}
class AsyncServerManager {
-BitField serverIds
-ArrayList~AsyncServer~ servers
+allocateServerId()
+addServer(AsyncServer)
+removeServer(AsyncServer)
}
class TcpClientConnection {
-Map~Integer, Session~ sessions
-Map~Integer, AsyncCallback~ callbackMap
-AtomicInteger nextId
+close()
+addSession(int, Session)
+removeSession(int)
}
class TcpServerConnection {
-HashMap~Integer, ServerSessionInfo~ sessions
+handleRequest(TransferInputStream, int, int)
+createSession(SessionInit, int, int)
+closeSession(int, int)
}
class TransferConnection {
-TransferInputStream in
-TransferOutputStream out
+handle(NetBuffer, boolean)
+sendError(Session, int, Throwable)
}
class AsyncConnectionPool {
-AsyncConnection[] list
+getConnection()
+addConnection(AsyncConnection)
+removeConnection(AsyncConnection)
}
AsyncConnection <|-- TransferConnection
TransferConnection <|-- TcpClientConnection
TransferConnection <|-- TcpServerConnection
AsyncConnectionManager <|-- AsyncServer
AsyncServerManager "1" --> "*" AsyncServer
NetClientBase "1" --> "*" AsyncConnectionPool
AsyncConnectionPool "1" --> "*" AsyncConnection
```

**图示来源**
- [AsyncConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnection.java)
- [AsyncConnectionManager.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnectionManager.java)
- [AsyncServerManager.java](https://github.com/lealone/Lealone/blob/master/lealone-server/src/main/java/com/lealone/server/AsyncServerManager.java)
- [TcpClientConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/TcpClientConnection.java)
- [TcpServerConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-server/src/main/java/com/lealone/server/TcpServerConnection.java)
- [TransferConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/TransferConnection.java)
- [AsyncConnectionPool.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnectionPool.java)

**本节来源**
- [AsyncConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnection.java)
- [AsyncConnectionManager.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnectionManager.java)
- [AsyncServerManager.java](https://github.com/lealone/Lealone/blob/master/lealone-server/src/main/java/com/lealone/server/AsyncServerManager.java)
- [TcpClientConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/TcpClientConnection.java)
- [TcpServerConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-server/src/main/java/com/lealone/server/TcpServerConnection.java)
- [TransferConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/TransferConnection.java)
- [AsyncConnectionPool.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnectionPool.java)

## 连接创建流程

连接创建流程始于客户端发起连接请求，经过网络层接收后创建AsyncConnection对象。该流程涉及多个组件的协作，确保连接被正确创建和管理。

当客户端发起连接请求时，服务器的NetServerBase通过其accept方法接收连接。NetServerBase首先检查连接管理器(AsyncConnectionManager)是否已设置，然后调用createConnection方法创建新的连接实例。

在AsyncServer实现中，createConnection方法被重写以处理具体的连接创建逻辑。该方法首先检查是否允许来自该主机的连接，如果允许，则调用抽象方法createConnection创建具体的连接对象。创建成功后，连接被注册到事件循环(NetEventLoop)中，并更新连接计数。

对于TCP连接，TcpServer创建TcpServerConnection实例，该实例继承自AsyncServerConnection。连接创建过程中，系统会为连接分配输入和输出缓冲区(NetBuffer)，并将其与调度器(Scheduler)关联。

客户端连接的创建流程类似，但由NetClientBase负责。当客户端需要创建连接时，首先检查连接池中是否存在可用连接。如果存在且符合配置要求，则复用现有连接；否则创建新连接。

```mermaid
sequenceDiagram
participant Client as 客户端
participant NetServer as NetServerBase
participant AsyncServer as AsyncServer
participant ConnectionManager as AsyncConnectionManager
participant EventLoop as NetEventLoop
Client->>NetServer : 发起连接请求
NetServer->>AsyncServer : createConnection()
AsyncServer->>AsyncServer : 检查连接权限
alt 允许连接
AsyncServer->>AsyncServer : createConnection(具体实现)
AsyncServer->>ConnectionManager : createConnection()
ConnectionManager-->>AsyncServer : 返回AsyncConnection
AsyncServer->>AsyncServer : connectionSize.incrementAndGet()
AsyncServer->>EventLoop : register(conn)
AsyncServer-->>NetServer : 返回连接
NetServer-->>Client : 连接建立成功
else 拒绝连接
AsyncServer->>NetServer : 关闭通道并抛出异常
NetServer-->>Client : 连接被拒绝
end
```

**图示来源**
- [NetServerBase.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/NetServerBase.java)
- [AsyncServer.java](https://github.com/lealone/Lealone/blob/master/lealone-server/src/main/java/com/lealone/server/AsyncServer.java)
- [AsyncConnectionManager.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnectionManager.java)

**本节来源**
- [NetServerBase.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/NetServerBase.java)
- [AsyncServer.java](https://github.com/lealone/Lealone/blob/master/lealone-server/src/main/java/com/lealone/server/AsyncServer.java)
- [AsyncConnectionManager.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnectionManager.java)

## 身份验证与会话建立

身份验证与会话建立是连接生命周期中的关键阶段，确保只有经过验证的客户端才能访问数据库资源。该过程通过SessionInit和SessionInitAck协议包实现。

当客户端连接建立后，会发送SessionInit包到服务器。TcpServerConnection的handleRequest方法接收到该请求后，调用readInitPacket方法读取初始化数据包。系统创建SessionInitTask任务，并将其提交给调度器处理。

SessionInitTask执行createSession方法，该方法使用ConnectionInfo创建ServerSession实例。身份验证在此过程中完成，系统检查用户名和密码的正确性。如果验证成功，系统调用addSession方法将新会话添加到会话映射中，并发送SessionInitAck响应包。

在addSession方法中，系统为会话创建ServerSessionInfo对象，该对象包含会话的调度信息和任务队列。会话被设置为当前调度器，并创建过期映射(ExpiringMap)用于缓存管理。ServerSessionInfo被添加到调度器的会话信息列表中。

客户端收到SessionInitAck响应后，根据响应中的协议版本、自动提交状态、目标节点等信息初始化ClientSession。客户端会话建立完成后，即可开始发送SQL请求。

```mermaid
sequenceDiagram
participant Client as 客户端
participant Server as TcpServerConnection
participant Task as SessionInitTask
participant Session as ServerSession
Client->>Server : 发送SessionInit包
Server->>Server : readInitPacket()
Server->>Task : 创建SessionInitTask
Server->>Scheduler : 提交SessionInitTask
Scheduler->>Task : 执行run()
Task->>Task : createSession()
Task->>Session : packet.ci.createSession()
alt 验证成功
Task->>Task : addSession(session, sessionId)
Task->>Task : sendSessionInitAck()
Task-->>Scheduler : 任务完成
Scheduler-->>Server : 处理完成
Server-->>Client : SessionInitAck响应
Client->>Client : 初始化ClientSession
else 验证失败
Task->>Task : sendError()
Task-->>Scheduler : 任务完成
Scheduler-->>Server : 处理完成
Server-->>Client : 错误响应
end
```

**图示来源**
- [TcpServerConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-server/src/main/java/com/lealone/server/TcpServerConnection.java)
- [SessionInitTask.java](https://github.com/lealone/Lealone/blob/master/lealone-server/src/main/java/com/lealone/server/scheduler/SessionInitTask.java)
- [ClientSessionFactory.java](https://github.com/lealone/Lealone/blob/master/lealone-client/src/main/java/com/lealone/client/session/ClientSessionFactory.java)

**本节来源**
- [TcpServerConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-server/src/main/java/com/lealone/server/TcpServerConnection.java)
- [ClientSessionFactory.java](https://github.com/lealone/Lealone/blob/master/lealone-client/src/main/java/com/lealone/client/session/ClientSessionFactory.java)

## 连接状态管理

连接状态管理是确保系统稳定性和资源高效利用的关键。Lealone通过多种机制实现连接状态的有效管理，包括连接池、超时检测和状态监控。

AsyncConnectionPool是连接池的核心实现，它维护一个连接列表，支持连接的获取、添加和移除。连接池根据配置决定是否共享连接，以及最大共享大小。当获取连接时，系统优先选择负载最低的连接。

NetClientBase和NetServerBase都维护连接池映射，以InetSocketAddress为键。这种设计避免了localhost和127.0.0.1被视为不同地址的问题，提高了连接复用率。

系统通过checkTimeout方法实现连接超时检测。AsyncConnectionManager定期调用checkTimeout，检查每个连接的回调超时情况。对于长时间无活动的连接，系统会自动关闭以释放资源。

连接状态通过isClosed标志管理，所有操作前都会调用checkClosed方法验证连接状态。异常处理通过handleException方法实现，当发生异常时，连接会被标记为关闭并从连接池中移除。

```mermaid
flowchart TD
Start([开始]) --> CheckPool["检查连接池"]
CheckPool --> PoolEmpty{"连接池为空?"}
PoolEmpty --> |是| CreateNew["创建新连接"]
PoolEmpty --> |否| GetExisting["获取现有连接"]
GetExisting --> CheckShared["检查共享配置"]
CheckShared --> SelectBest["选择最佳连接"]
SelectBest --> Validate["验证连接状态"]
Validate --> IsClosed{"连接已关闭?"}
IsClosed --> |是| Remove["从池中移除"]
Remove --> CreateNew
IsClosed --> |否| Use["使用连接"]
Use --> Monitor["监控连接活动"]
Monitor --> CheckTimeout["检查超时"]
CheckTimeout --> Timeout{"超时?"}
Timeout --> |是| Close["关闭连接"]
Timeout --> |否| Continue["继续使用"]
Continue --> Monitor
Close --> Cleanup["清理资源"]
Cleanup --> End([结束])
CreateNew --> AddToPool["添加到连接池"]
AddToPool --> Use
```

**图示来源**
- [AsyncConnectionPool.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnectionPool.java)
- [NetClientBase.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/NetClientBase.java)
- [AsyncConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnection.java)

**本节来源**
- [AsyncConnectionPool.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnectionPool.java)
- [NetClientBase.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/NetClientBase.java)
- [AsyncConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnection.java)

## 连接关闭与资源释放

连接关闭与资源释放是连接生命周期的最后阶段，确保所有相关资源被正确清理。该过程涉及多个组件的协作，包括连接本身、会话、回调和缓冲区。

当连接需要关闭时，系统调用close方法。该方法首先检查连接是否已关闭，避免重复关闭。然后关闭输入流，确保不再接收新数据。对于客户端连接，系统会处理未完成的回调，设置连接中断异常，避免等待线程无限期阻塞。

在TcpClientConnection中，close方法会遍历所有会话并调用其close方法。这确保了所有相关的数据库会话都被正确关闭。会话映射在最后被清空，释放内存资源。

服务器端的TcpServerConnection有类似的关闭流程，但需要额外处理会话信息。系统会遍历所有ServerSessionInfo，调用closeSession方法。在closeSession中，系统执行事务回滚，关闭会话，并从调度器中移除会话信息。

资源释放还包括缓冲区的清理和事件循环的注销。WritableChannel的close方法负责释放底层网络资源。连接从连接池中移除后，如果池为空，则从全局映射中删除。

```mermaid
sequenceDiagram
participant Connection as AsyncConnection
participant ClientConn as TcpClientConnection
participant ServerConn as TcpServerConnection
participant Session as ServerSession
participant Pool as AsyncConnectionPool
Connection->>Connection : close()
Connection->>Connection : 检查是否已关闭
alt 客户端连接
ClientConn->>ClientConn : 关闭输入流
ClientConn->>ClientConn : 处理未完成回调
loop 每个会话
ClientConn->>Session : session.close()
end
ClientConn->>ClientConn : 清空会话映射
else 服务器端连接
ServerConn->>ServerConn : 关闭输入流
loop 每个ServerSessionInfo
ServerConn->>ServerConn : closeSession(si, true)
end
ServerConn->>ServerConn : 清空会话映射
end
Connection->>WritableChannel : channel.close()
Connection->>Pool : 从连接池移除
alt 连接池为空
Pool->>Pool : 从全局映射删除
end
```

**图示来源**
- [TcpClientConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/TcpClientConnection.java)
- [TcpServerConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-server/src/main/java/com/lealone/server/TcpServerConnection.java)
- [AsyncConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnection.java)
- [AsyncConnectionPool.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnectionPool.java)

**本节来源**
- [TcpClientConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/TcpClientConnection.java)
- [TcpServerConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-server/src/main/java/com/lealone/server/TcpServerConnection.java)
- [AsyncConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnection.java)

## AsyncConnectionManager与AsyncServerManager协作

AsyncConnectionManager和AsyncServerManager在连接生命周期管理中扮演着关键角色，它们通过紧密协作实现高效的连接管理。

AsyncConnectionManager作为连接管理的接口，定义了创建和移除连接的基本操作。AsyncServer实现了这个接口，成为具体的连接管理者。当服务器需要创建新连接时，通过AsyncConnectionManager的createConnection方法委托给AsyncServer处理。

AsyncServerManager则负责管理所有AsyncServer实例的生命周期。当AsyncServer初始化时，调用AsyncServerManager的addServer方法将其注册到全局服务器列表中。服务器停止时，调用removeServer方法从列表中移除。

两个组件在连接接受(accept)事件处理上紧密协作。AsyncServer的registerAccepter方法通过AsyncServerManager注册接受者任务。当需要轮换接受者时，AsyncServerManager的registerAccepterIfNeed方法被调用，将接受事件的处理权转移给下一个调度器。

这种设计实现了连接接受的负载均衡，避免单个调度器成为瓶颈。通过将接受事件分散到多个调度器，系统能够更好地利用多核CPU的处理能力。

```mermaid
sequenceDiagram
participant Server as AsyncServer
participant Manager as AsyncServerManager
participant Scheduler as Scheduler
Server->>Manager : addServer(this)
Manager->>Manager : 添加到servers列表
Manager->>Manager : 分配serverId
Manager->>Manager : 创建RegisterAccepterTask
Server->>Server : init(config)
Server->>Manager : allocateServerId()
Server->>Manager : addServer(this)
Server->>Server : 创建NetServer
Server->>NetServer : setConnectionManager(this)
Server->>Manager : registerAccepter(serverChannel, scheduler)
Manager->>Manager : 获取RegisterAccepterTask
Manager->>Manager : 设置asyncServer和nextScheduler
Manager->>Manager : needRegisterAccepter = true
Scheduler->>Manager : runRegisterAccepterTasks()
Manager->>Manager : 遍历registerAccepterTasks
Manager->>Manager : 执行RegisterAccepterTask.run()
Manager->>Server : 注册OP_ACCEPT事件
Server->>Manager : registerAccepterIfNeed(asyncServer, currentScheduler)
Manager->>Scheduler : 获取下一个调度器
Manager->>Manager : 转移accept事件处理权
Manager->>Scheduler : wakeUp()
```

**图示来源**
- [AsyncServer.java](https://github.com/lealone/Lealone/blob/master/lealone-server/src/main/java/com/lealone/server/AsyncServer.java)
- [AsyncServerManager.java](https://github.com/lealone/Lealone/blob/master/lealone-server/src/main/java/com/lealone/server/AsyncServerManager.java)

**本节来源**
- [AsyncServer.java](https://github.com/lealone/Lealone/blob/master/lealone-server/src/main/java/com/lealone/server/AsyncServer.java)
- [AsyncServerManager.java](https://github.com/lealone/Lealone/blob/master/lealone-server/src/main/java/com/lealone/server/AsyncServerManager.java)

## 关键方法实现细节

连接生命周期管理涉及多个关键方法的实现，这些方法定义了连接管理的核心逻辑。

**connect方法** 实际上是通过createConnection方法实现的。在AsyncServer中，createConnection方法首先检查连接权限，然后创建具体的连接对象。连接创建后，立即注册到事件循环中，并更新连接计数。最后，调用registerAccepterIfNeed方法，可能将accept事件处理权转移给其他调度器。

**disconnect方法** 由removeConnection方法实现。在AsyncServer中，removeConnection方法减少连接计数，然后调用连接的close方法。这触发了连接的关闭流程，包括资源释放和状态清理。

**close方法** 在AsyncConnection中定义，是连接关闭的核心。该方法设置closed标志，然后关闭底层可写通道。子类如TcpClientConnection和TcpServerConnection重写此方法以实现特定的资源清理逻辑。

**createConnection方法** 在AsyncConnectionManager接口中定义，由AsyncServer实现。该方法是连接创建的入口点，负责连接的实例化和初始化。

**removeConnection方法** 同样在AsyncConnectionManager接口中定义，由AsyncServer实现。该方法负责连接的清理和资源释放。

```mermaid
flowchart TD
A[createConnection] --> B[检查连接权限]
B --> C{允许连接?}
C --> |是| D[创建连接对象]
C --> |否| E[关闭通道并抛出异常]
D --> F[增加连接计数]
F --> G[注册到事件循环]
G --> H[可能转移accept事件]
H --> I[返回连接对象]
J[removeConnection] --> K[减少连接计数]
K --> L[调用连接close方法]
L --> M[清理资源]
N[close] --> O[设置closed标志]
O --> P[关闭可写通道]
P --> Q[子类特定清理]
R[registerAccepter] --> S[创建RegisterAccepterTask]
S --> T[设置asyncServer和nextScheduler]
T --> U[标记needRegisterAccepter]
U --> V[唤醒调度器]
```

**图示来源**
- [AsyncServer.java](https://github.com/lealone/Lealone/blob/master/lealone-server/src/main/java/com/lealone/server/AsyncServer.java)
- [AsyncConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnection.java)
- [TcpClientConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/TcpClientConnection.java)
- [TcpServerConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-server/src/main/java/com/lealone/server/TcpServerConnection.java)

**本节来源**
- [AsyncServer.java](https://github.com/lealone/Lealone/blob/master/lealone-server/src/main/java/com/lealone/server/AsyncServer.java)
- [AsyncConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnection.java)

## 连接泄漏检测与性能监控

连接泄漏检测与性能监控是确保系统稳定运行的重要机制。Lealone通过多种方式实现连接泄漏的预防和检测。

**连接池监控** 通过AsyncConnectionPool实现。系统定期检查连接池中的连接状态，对超时连接进行清理。连接池的isEmpty方法可用于监控连接使用情况。

**超时检测** 通过checkTimeout方法实现。系统定期调用此方法，检查每个连接的回调超时情况。对于长时间无活动的连接，系统会自动关闭以防止资源泄漏。

**会话生命周期管理** 在Database类中实现。当会话被移除时，系统检查用户会话列表是否为空。如果为空且设置了关闭延迟，系统会启动数据库关闭流程，避免资源浪费。

**资源使用监控** 通过连接计数器实现。AsyncServer维护connectionSize原子计数器，实时跟踪当前连接数。这可用于性能监控和容量规划。

**异常处理监控** 通过日志记录实现。系统在关键操作点记录连接状态变化和异常情况，便于问题排查和性能分析。

```mermaid
flowchart TD
A[连接泄漏检测] --> B[连接池监控]
A --> C[超时检测]
A --> D[会话生命周期管理]
A --> E[资源使用监控]
A --> F[异常处理监控]
B --> G[定期检查连接池]
G --> H{连接超时?}
H --> |是| I[关闭连接]
H --> |否| J[继续监控]
C --> K[定期调用checkTimeout]
K --> L[检查回调超时]
L --> M{超时?}
M --> |是| N[设置超时异常]
M --> |否| O[继续等待]
D --> P[会话移除]
P --> Q{用户会话为空?}
Q --> |是| R[启动关闭流程]
Q --> |否| S[继续运行]
E --> T[监控connectionSize]
T --> U[生成性能报告]
F --> V[记录关键操作日志]
V --> W[分析异常模式]
```

**图示来源**
- [AsyncConnectionPool.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnectionPool.java)
- [AsyncConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnection.java)
- [Database.java](https://github.com/lealone/Lealone/blob/master/lealone-db/src/main/java/com/lealone/db/Database.java)
- [AsyncServer.java](https://github.com/lealone/Lealone/blob/master/lealone-server/src/main/java/com/lealone/server/AsyncServer.java)

**本节来源**
- [AsyncConnectionPool.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnectionPool.java)
- [AsyncConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnection.java)
- [Database.java](https://github.com/lealone/Lealone/blob/master/lealone-db/src/main/java/com/lealone/db/Database.java)

## 最佳实践

为了确保Lealone连接生命周期管理的高效和稳定，开发者应遵循以下最佳实践：

**合理配置连接池** 根据应用需求设置合适的连接池大小和超时参数。避免连接池过大导致资源浪费，或过小导致性能瓶颈。

**及时关闭连接** 确保在使用完连接后及时调用close方法。使用try-with-resources语句或finally块确保连接被正确关闭。

**监控连接状态** 定期监控连接池使用情况和连接计数，及时发现潜在的连接泄漏问题。

**处理异常情况** 正确处理连接相关的异常，避免因未处理的异常导致连接资源无法释放。

**优化会话管理** 合理管理会话生命周期，避免创建过多的会话对象。对于长时间运行的操作，考虑使用批处理或异步处理。

**性能调优** 根据实际负载调整调度器和事件循环的配置，优化连接接受和处理的性能。

**日志分析** 定期分析连接相关的日志，识别性能瓶颈和异常模式。

**资源清理** 确保所有与连接相关的资源（如结果集、语句等）都被正确清理。

```mermaid
flowchart TD
A[最佳实践] --> B[合理配置连接池]
A --> C[及时关闭连接]
A --> D[监控连接状态]
A --> E[处理异常情况]
A --> F[优化会话管理]
A --> G[性能调优]
A --> H[日志分析]
A --> I[资源清理]
B --> J[设置合适的maxSharedSize]
B --> K[配置合理的超时时间]
C --> L[使用try-with-resources]
C --> M[在finally块中关闭]
D --> N[监控connectionSize]
D --> O[检查连接池使用率]
E --> P[捕获并处理异常]
E --> Q[避免异常导致资源泄漏]
F --> R[复用会话]
F --> S[避免频繁创建]
G --> T[调整调度器数量]
G --> U[优化事件循环]
H --> V[分析连接日志]
H --> W[识别性能瓶颈]
I --> X[关闭结果集]
I --> Y[关闭语句]
```

**图示来源**
- [AsyncConnectionPool.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnectionPool.java)
- [AsyncConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnection.java)
- [TcpClientConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/TcpClientConnection.java)

**本节来源**
- [AsyncConnectionPool.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnectionPool.java)
- [AsyncConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/AsyncConnection.java)
- [TcpClientConnection.java](https://github.com/lealone/Lealone/blob/master/lealone-net/src/main/java/com/lealone/net/TcpClientConnection.java)